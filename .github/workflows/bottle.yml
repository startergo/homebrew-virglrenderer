name: Build Bottles

concurrency:
  group: bottle-build
  cancel-in-progress: false

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: "0 0 * * 0"
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to tag (e.g., 1.0.0 or 2025.12.27)'
        required: false
        default: ''
      release:
        description: 'Create GitHub release?'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      virglrenderer_commit: ${{ steps.virglrenderer_commit.outputs.commit }}
      create_release: ${{ steps.version.outputs.create_release }}
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history and tags for git describe

      - id: virglrenderer_commit
        run: |
          # Get latest virglrenderer commit hash from upstream GitLab
          COMMIT=$(git ls-remote https://gitlab.freedesktop.org/virgl/virglrenderer.git HEAD | awk '{ print $1 }')
          SHORT_COMMIT=${COMMIT:0:8}
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "virglrenderer commit: $SHORT_COMMIT"

      - id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # If no version specified, use git describe to determine next version
          if [ -z "$VERSION" ]; then
            # Get git describe output (e.g., v1.0.5-2-gf20b3d8)
            DESCRIBE=$(git describe --tags 2>/dev/null || echo "v1.0.0")

            # Check if we're ahead of a tag (contains dash)
            if [[ "$DESCRIBE" =~ "-" ]]; then
              # Extract current version from describe (first part before dash)
              CURRENT=$(echo "$DESCRIBE" | cut -d- -f1 | sed 's/^v//')
              COMMITS_AHEAD=$(echo "$DESCRIBE" | cut -d- -f2)
              echo "Current tag: v$CURRENT, $COMMITS_AHEAD commits ahead"
              # Increment patch version
              VERSION=$(echo "$CURRENT" | awk -F. '{print $1"."$2"."$3+1}')
            else
              # Exactly on a tag, increment it
              CURRENT=${DESCRIBE#v}
              VERSION=$(echo "$CURRENT" | awk -F. '{print $1"."$2"."$3+1}')
              echo "On tag v$CURRENT, incrementing to v$VERSION"
            fi
          fi

          # Validate version is not empty and follows expected format
          if [ -z "$VERSION" ]; then
            echo "ERROR: Version is empty!"
            exit 1
          fi
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid version format: $VERSION"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

          # Create release for scheduled runs and workflow_dispatch with release=true
          # Push events do NOT create releases (only update source tarball)
          if [ "${{ github.event.inputs.release }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "create_release=true" >> $GITHUB_OUTPUT
            echo "DEBUG: create_release=true"
          else
            echo "create_release=false" >> $GITHUB_OUTPUT
            echo "DEBUG: create_release=false"
          fi
          # Verify the output was set
          echo "DEBUG: Final create_release value check"

  update-source-tarball:
    needs: determine-version
    runs-on: ubuntu-latest
    # Only run on push events (when create_release=false)
    # Also skip when we're building bottles (create_release=true)
    # Skip if the HEAD commit is from this job (to prevent infinite loop)
    if: github.event_name == 'push' && needs.determine-version.outputs.create_release == 'false'
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history and tags for git log checks

      - name: Check if we should run
        id: check
        run: |
          # Skip if HEAD commit is from update-source-tarball job (prevents infinite loop)
          if git log -1 --pretty=%B | grep -q "source tarball sha256 to"; then
            echo "Skipping: HEAD commit is from update-source-tarball job"
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            # Also skip if HEAD commit is from publish-bottles job (tag will be updated after release)
            if git log -1 --pretty=%B | grep -q "Update to v.* with bottles"; then
              echo "Skipping: HEAD commit is from publish-bottles job, tag was just updated"
              echo "should_run=false" >> $GITHUB_OUTPUT
            else
              echo "should_run=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Set up Git
        if: steps.check.outputs.should_run == 'true'
        uses: Homebrew/actions/git-user-config@master
        with:
          username: "startergo"

      - name: Update tag and calculate new sha256
        if: steps.check.outputs.should_run == 'true'
        run: |
          # Extract version from formula URL or version line (fallback)
          VERSION=$(grep 'url.*archive/refs/tags/v' Formula/virglrenderer.rb 2>/dev/null | sed -E 's/.*v([0-9.]+)\.tar\.gz.*/\1/')
          # Fallback: extract from version line if URL uses commit hash
          if [ -z "$VERSION" ]; then
            VERSION=$(grep '^  version "' Formula/virglrenderer.rb | sed -E 's/.*version "([0-9.]+)".*/\1/')
            echo "Extracted version from version line (URL uses commit hash)"
          fi

          # Validate version before creating tag
          if [ -z "$VERSION" ]; then
            echo "ERROR: Cannot create tag - version is empty!"
            echo "This could indicate a problem with the formula URL parsing."
            exit 1
          fi
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Cannot create tag - invalid version format: $VERSION"
            exit 1
          fi
          echo "Validated version: $VERSION"

          # Force update the existing tag to point to current HEAD
          # This updates the tarball at refs/tags/v$VERSION to contain latest code
          git tag -f "v$VERSION" HEAD
          git push -f origin "v$VERSION"
          echo "Updated tag v$VERSION to point to commit $(git rev-parse HEAD)"

          # Wait a moment for GitHub to update the tarball
          sleep 5

          # Download the tarball that the formula URL points to and calculate its sha256
          # Extract the current URL from the formula to determine which tarball to checksum
          CURRENT_URL=$(grep '^  url "' Formula/virglrenderer.rb | sed -E 's/.*url "([^"]+)".*/\1/')
          echo "Current formula URL: $CURRENT_URL"

          # If formula uses commit URL, download that commit's tarball
          if [[ "$CURRENT_URL" =~ archive/([a-f0-9]+)\.tar\.gz ]]; then
            COMMIT=$(echo "$CURRENT_URL" | sed -E 's/.*archive\/([a-f0-9]+)\.tar\.gz.*/\1/')
            TARBALL_URL="https://github.com/startergo/homebrew-virglrenderer/archive/${COMMIT}.tar.gz"
            echo "Formula uses commit URL, downloading commit tarball"
          else
            # Formula uses tag URL, download tag tarball
            TARBALL_URL="https://github.com/startergo/homebrew-virglrenderer/archive/refs/tags/v${VERSION}.tar.gz"
            echo "Formula uses tag URL, downloading tag tarball"
          fi

          echo "Downloading tarball from: $TARBALL_URL"
          curl -L -o "virglrenderer-${VERSION}.tar.gz" "$TARBALL_URL"

          # Calculate sha256
          NEW_SHA256=$(sha256sum "virglrenderer-${VERSION}.tar.gz" | awk '{print $1}')
          echo "New sha256: $NEW_SHA256"

          # Update formula with new sha256
          awk -v new_sha256="$NEW_SHA256" '
            /^  sha256/ && !in_bottle {
              print "  sha256 \"" new_sha256 "\""
              next
            }
            /^  bottle do/ { in_bottle=1 }
            /^  end/ && in_bottle { in_bottle=0 }
            { print }
          ' Formula/virglrenderer.rb > Formula/virglrenderer.rb.tmp
          mv Formula/virglrenderer.rb.tmp Formula/virglrenderer.rb

          # Show the updated formula for verification
          echo "=== Updated formula ==="
          head -15 Formula/virglrenderer.rb

          # Commit and push formula
          git add Formula/virglrenderer.rb
          # Only commit if there are changes (sha256 might already be correct)
          if git diff --cached --quiet; then
            echo "No changes to commit (sha256 was already correct)"
          else
            git commit -m "Update $VERSION source tarball sha256 to $NEW_SHA256"
            git push origin master
          fi

  build-and-publish-bottles:
    needs: [determine-version, update-source-tarball]
    runs-on: macos-latest
    # Only run when create_release=true (workflow_dispatch or schedule)
    # always() ensures this runs even if update-source-tarball was skipped
    if: always() && needs.determine-version.outputs.create_release == 'true' && (needs.update-source-tarball.result == 'success' || needs.update-source-tarball.result == 'skipped')
    env:
      VERSION: ${{ needs.determine-version.outputs.version }}
      VIRGLRENDERER_COMMIT: ${{ needs.determine-version.outputs.virglrenderer_commit }}
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Set up Git
        uses: Homebrew/actions/git-user-config@master
        with:
          username: "startergo"

      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history and tags

      - name: Show formula state before update
        run: |
          echo "=== Formula before ==="
          head -20 Formula/virglrenderer.rb

      - name: Update formula to new version (uncommitted)
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          COMMIT=$(git rev-parse HEAD)
          echo "=== Updating formula: version $VERSION, url to commit $COMMIT ==="

          # Add version line and update URL to point to current commit
          # This ensures version and URL are in sync for correct bottle filename
          awk -v new_version="$VERSION" -v commit="$COMMIT" '
            BEGIN { inserted = 0 }
            /^  url "https:\/\/github.com\/startergo\/homebrew-virglrenderer\/archive\// {
              if (!inserted) {
                print "  version \"" new_version "\""
                inserted = 1
              }
              print "  url \"https://github.com/startergo/homebrew-virglrenderer/archive/" commit ".tar.gz\""
              next
            }
            { print }
          ' Formula/virglrenderer.rb > Formula/virglrenderer.rb.tmp
          mv Formula/virglrenderer.rb.tmp Formula/virglrenderer.rb

          echo "=== Formula updated (version $VERSION, url to commit) ==="
          head -20 Formula/virglrenderer.rb

          # Download commit tarball and calculate its sha256
          # This is needed because the commit tarball has different content than the tag tarball
          TARBALL_URL="https://github.com/startergo/homebrew-virglrenderer/archive/${COMMIT}.tar.gz"
          echo "=== Downloading commit tarball to calculate sha256 ==="
          echo "URL: $TARBALL_URL"
          curl -L -o "commit.tar.gz" "$TARBALL_URL"
          COMMIT_SHA256=$(shasum -a 256 commit.tar.gz | awk '{print $1}')
          echo "Commit tarball sha256: $COMMIT_SHA256"

          # Update formula with the commit tarball's sha256
          awk -v new_sha256="$COMMIT_SHA256" '
            BEGIN { in_bottle=0 }
            /^  sha256/ && !in_bottle {
              print "  sha256 \"" new_sha256 "\""
              next
            }
            /^  bottle do/ { in_bottle=1 }
            /^  end/ && in_bottle { in_bottle=0 }
            { print }
          ' Formula/virglrenderer.rb > Formula/virglrenderer.rb.tmp
          mv Formula/virglrenderer.rb.tmp Formula/virglrenderer.rb

          echo "=== Formula with updated sha256 ==="
          head -20 Formula/virglrenderer.rb

          # Save COMMIT_SHA256 for the Build bottle step
          echo "$COMMIT_SHA256" > commit_sha256.txt

      - name: Build bottle
        run: |
          set -x
          TAP_DIR="$(brew --repository)/Library/Taps/startergo/homebrew-virglrenderer"
          mkdir -p "$TAP_DIR/Formula"

          CURRENT_DIR="$(pwd)"
          if [ -L "$TAP_DIR" ] && [ "$(readlink -f "$TAP_DIR")" = "$(readlink -f "$CURRENT_DIR")" ]; then
            echo "Tap is symlinked to current directory, skipping copy"
          else
            # Copy the formula to the tap
            echo "Copying formula to tap..."
            cp Formula/virglrenderer.rb "$TAP_DIR/Formula/"

            # Copy patches directory to tap (needed by formula install block)
            if [ -d "patches" ]; then
              echo "Copying patches directory to tap..."
              cp -r patches "$TAP_DIR/"
              echo "Copied patches directory to tap"
              ls -la patches/
              ls -la "$TAP_DIR/patches/"
            fi
          fi

          export HOMEBREW_NO_INSTALL_FROM_API=1
          brew uninstall virglrenderer --force 2>/dev/null || true

          # Install dependencies first
          brew tap startergo/angle
          brew tap startergo/libepoxy
          brew install meson ninja pkg-config

          # Build bottle
          brew install --build-bottle startergo/virglrenderer/virglrenderer
          brew link --overwrite virglrenderer || true

          # Create bottle
          brew bottle --json --root-url="https://github.com/startergo/homebrew-virglrenderer/releases/download/v${VERSION}" --force-core-tap "$TAP_DIR/Formula/virglrenderer.rb"

          # Save formula before merge
          cp Formula/virglrenderer.rb Formula/virglrenderer.rb.before-merge

          # Merge JSON into formula
          brew bottle --merge --write *.json

          # Restore explicit version if needed
          if ! grep -q "^  version \"$VERSION\"" Formula/virglrenderer.rb; then
            awk -v new_version="$VERSION" '
              /^  sha256/ && !in_bottle {
                print "  version \"" new_version "\""
              }
              { print }
            ' Formula/virglrenderer.rb > Formula/virglrenderer.rb.tmp
            mv Formula/virglrenderer.rb.tmp Formula/virglrenderer.rb
          fi

      - name: Rename bottle to single-dash format
        run: |
          for json in *.json; do
            SINGLE_DASH=$(jq -r '[.. | objects | select(.filename) | .filename] | join(",")' "$json" 2>/dev/null | head -1)
            if [ -n "$SINGLE_DASH" ]; then
              DOUBLE_DASH=$(ls virglrenderer--*.tar.gz 2>/dev/null | head -1)
              if [ -n "$DOUBLE_DASH" ]; then
                mv "$DOUBLE_DASH" "$SINGLE_DASH"
              fi
            fi
          done

      - name: Verify bottle was built successfully
        run: |
          # Check if bottle tarball exists
          if ! ls virglrenderer-*.tar.gz 2>/dev/null | grep -q .; then
            echo "ERROR: No bottle tarball found! Build may have failed."
            echo "Cannot proceed with creating release."
            exit 1
          fi
          echo "Bottle tarball(s) found:"
          ls -la virglrenderer-*.tar.gz

      - name: Configure git credentials
        run: |
          git config --global url.https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/.insteadOf https://github.com/

      - name: Update formula with version and tag URL (temporary)
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          echo "=== Updating formula: version $VERSION, tag URL ==="

          # Update formula with version and tag URL (keep existing sha256 temporarily)
          awk -v version="$VERSION" '
            BEGIN { in_bottle=0; added_version=0; printed_version=0 }
            /^  version / {
              if (!printed_version) {
                print "  version \"" version "\""
                printed_version=1
              }
              added_version=1
              next
            }
            /^  url "https:\/\/github.com\/startergo\/homebrew-virglrenderer\/archive\// {
              if (!added_version) {
                print "  version \"" version "\""
                printed_version=1
                added_version=1
              }
              print "  url \"https://github.com/startergo/homebrew-virglrenderer/archive/refs/tags/v" version ".tar.gz\""
              next
            }
            { print }
          ' Formula/virglrenderer.rb > Formula/virglrenderer.rb.tmp
          mv Formula/virglrenderer.rb.tmp Formula/virglrenderer.rb

          echo "=== Formula with tag URL (temporary) ==="
          head -20 Formula/virglrenderer.rb

          git add Formula/virglrenderer.rb
          git commit -m "Update to v$VERSION with bottles"
          git push origin master

      - name: Create GitHub Release
        if: success() # Only run if all previous steps in this job succeeded
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # CRITICAL: Validate version before creating release/tag
          # This is the final check to prevent creating empty "v" tags
          if [ -z "$VERSION" ]; then
            echo "ERROR: CRITICAL - Cannot create release - version is empty!"
            echo "This would create an empty 'v' tag. Aborting to prevent tag pollution."
            exit 1
          fi
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: CRITICAL - Cannot create release - invalid version format: '$VERSION'"
            echo "Expected format: X.Y.Z (e.g., 1.0.34)"
            echo "This would create a malformed tag. Aborting to prevent tag pollution."
            exit 1
          fi
          echo "âœ“ Version validated: v$VERSION"
          echo "Proceeding with release creation..."

          gh release create "v$VERSION" \
            --title "virglrenderer v$VERSION" \
            --notes "Built from upstream virglrenderer commit: $VIRGLRENDERER_COMMIT

          ### Bottles
          $(ls *.tar.gz 2>/dev/null | sed 's/^/- /' || echo '')" \
            --latest || true

          for tarball in virglrenderer-*.tar.gz; do
            if [ -f "$tarball" ]; then
              gh release upload "v$VERSION" "$tarball" || true
            fi
          done

      - name: Update formula with tag tarball sha256
        if: success() # Only run if all previous steps succeeded
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          TARBALL_URL="https://github.com/startergo/homebrew-virglrenderer/archive/refs/tags/v${VERSION}.tar.gz"
          echo "Downloading tag tarball to calculate sha256: $TARBALL_URL"
          curl -L -o "tag-tarball.tar.gz" "$TARBALL_URL"
          TAG_SHA256=$(shasum -a 256 tag-tarball.tar.gz | awk '{print $1}')
          echo "Tag tarball sha256: $TAG_SHA256"

          # Update formula with tag tarball sha256
          awk -v new_sha256="$TAG_SHA256" '
            BEGIN { in_bottle=0 }
            /^  sha256/ && !in_bottle {
              print "  sha256 \"" new_sha256 "\""
              next
            }
            /^  bottle do/ { in_bottle=1 }
            /^  end/ && in_bottle { in_bottle=0 }
            { print }
          ' Formula/virglrenderer.rb > Formula/virglrenderer.rb.tmp
          mv Formula/virglrenderer.rb.tmp Formula/virglrenderer.rb

          echo "=== Formula with tag sha256 ==="
          head -20 Formula/virglrenderer.rb

          git add Formula/virglrenderer.rb
          git commit --amend --no-edit
          git push -f origin master
